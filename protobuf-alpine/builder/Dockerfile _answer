FROM golang:1.20.1-alpine AS dl

WORKDIR /download
RUN echo "@testing http://dl-cdn.alpinelinux.org/alpine/edge/testing" >> /etc/apk/repositories && \
  apk add --no-cache unzip g++ linux-headers bazel4@testing && \
  wget -q "https://github.com/protocolbuffers/protobuf/archive/refs/tags/v22.0.zip" -O "protobuf.zip" && \
  unzip -o protobuf.zip -d protobuf && chmod -R 755 protobuf/* && \
  go install google.golang.org/protobuf/cmd/protoc-gen-go@latest && \
  go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

WORKDIR /download/protobuf/protobuf-22.0
RUN bazel build :protoc :protobuf

FROM golang:1.20.1-alpine AS builder

RUN apk add --no-cache g++

COPY --from=dl /download/protobuf/protobuf-22.0/bazel-bin/protoc /usr/local/bin/
COPY --from=dl /go/bin/protoc-gen-go /usr/local/bin/
COPY --from=dl /go/bin/protoc-gen-go-grpc /usr/local/bin/
